<?xml version="1.0" encoding="UTF-8"?>
<!--
 ************************************************************************************
 * Copyright (C) 2012-2021 Openbravo S.L.U.
 * Licensed under the Openbravo Commercial License version 1.0
 * You may obtain a copy of the License at http://www.openbravo.com/legal/obcl.html
 * or in the legal folder of this module distribution.
 ************************************************************************************
-->

<output>
  <ticket>
    <line>
        <image>ticket-image.png</image>
    </line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_ReturnRpt_Title')) %></text>
    </line>
    <line></line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckheader_line1'))%></text>
    </line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckheader_line2'))%></text>
    </line>
    <line></line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_ticket')) %></text>
      <text><%= OB.UTIL.encodeXMLComponent(order.get('documentNo')) %></text>
    </line>
    <line>
     <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_datetime')) %></text>
     <text><%= OB.I18N.formatDate(order.get('orderDate')) %></text>
       <text> </text>
       <% var time;
       if(!OB.UTIL.isNullOrUndefined(order.get('created'))){
         time = new Date(order.get('created'));       
       } else {
         time = new Date(); 
       }
       %>
      <text><%= OB.I18N.formatHour(time) %></text>
    </line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_cashierPOS')) %></text>
      <text><%= OB.UTIL.encodeXMLComponent(order.get('salesRepresentative'+OB.Constants.FIELDSEPARATOR + OB.Constants.IDENTIFIER)) %></text>
      <text>, </text>
      <text><%= OB.UTIL.encodeXMLComponent(order.get('posTerminal'+OB.Constants.FIELDSEPARATOR + OB.Constants.IDENTIFIER)) %></text>
    </line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LblTaxId')) %></text>
      <text><%= OB.UTIL.encodeXMLComponent(OB.MobileApp.model.get('terminal').organizationTaxId) %></text>
    </line>
    <line>
      <text><%= OB.UTIL.encodeXMLComponent(OB.MobileApp.model.get('terminal').organizationAddressIdentifier) %></text>
    </line>
    <line></line>
    <line size="1">
      <text align ="center" length="42"><%= OB.I18N.getLabel('OBPOS_ToReturn') %></text>
    </line>
    <line></line>
    
    <line>
      <text align ="left" length="21"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LineItem'))%></text>
      <text align ="center" length="5">#</text>
      <text align ="left" length="8"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LinePrice'))%></text>
      <text align ="left" length="8"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LineTotal'))%></text>
    </line>
    <line>
      <text>------------------------------------------</text>
    </line>
    <% 
      var lines = order.get('lines'), line, promotions;
      for (var i = 0; i < lines.length; i++) {
        line = lines.at(i);
    %>
      <line>
        <text align ="left" length="21"><%= OB.UTIL.encodeXMLComponent(lines.at(i).get('product').get('_identifier')) %></text>
        <text align ="center" length="5"><%= lines.at(i).printQty() %></text>
        <text align ="left" length="8"><%= lines.at(i).printPrice() %></text>
    <%if(order.get('priceIncludesTax')){%>
        <text align ="right" length="8"><%= lines.at(i).printGross() %></text>  
    <%}else{%>
        <text align ="right" length="8"><%= lines.at(i).printNet() %></text>
    <%}%>
      </line>
    <%if(line.has('organization') && OB.UTIL.isCrossStoreOrganization(line.get('organization'))){%>
      <line>
        <text align ="right">-- <%= line.get('organization').name %></text>  
      </line>
    <%}
    if (OB.MobileApp.model.hasPermission('OBRDM_EnableDeliveryModes', true)) {
      var deliveryDate = line.get('obrdmDeliveryDate') ? (line.get('obrdmDeliveryDate') instanceof Date ? line.get('obrdmDeliveryDate') : new Date(line.get('obrdmDeliveryDate'))) : null,
        deliveryTime = line.get('obrdmDeliveryTime') ? (line.get('obrdmDeliveryTime') instanceof Date ? line.get('obrdmDeliveryTime') : new Date(line.get('obrdmDeliveryTime'))) : null,
        showDate = line.get('obrdmDeliveryMode') === 'PickupInStoreDate' || line.get('obrdmDeliveryMode') === 'HomeDelivery',
        showTime = line.get('obrdmDeliveryMode') === 'HomeDelivery',
        deliveryName = line.get('nameDelivery') ? line.get('nameDelivery') : (line.get('obrdmDeliveryMode') ? _.find(OB.MobileApp.model.get('deliveryModes'), function (dm) {
           return dm.id === line.get('obrdmDeliveryMode');
         }).name : null);
     
     if (line.get('obrdmDeliveryMode') && deliveryName && (line.get('obrdmDeliveryMode') !== order.get('obrdmDeliveryModeProperty') || deliveryDate)) {
      var currentDate, currentTime;
      if (!deliveryDate) {
        currentDate = new Date();
        currentDate.setHours(0);
        currentDate.setMinutes(0);
        currentDate.setSeconds(0);
      }

      if (!deliveryTime) {
        currentTime = new Date();
        currentTime.setSeconds(0);
      }
     %>
      <line>
          <text align ="right">-- <%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBRDM_DeliveryMode'))%>: <%=deliveryName%></text>
      </line>
     <% if(showDate){%>
		<line>
          <text align ="right">-- <%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBRDM_DeliveryDate'))%>: <%=deliveryDate ? OB.I18N.formatDate(deliveryDate) : OB.I18N.formatDate(currentDate)%></text>
        </line>         
     <%}
      if(showTime){%>
		<line>
          <text align ="right">-- <%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBRDM_DeliveryTime'))%>: <%=deliveryTime ? OB.I18N.formatHour(deliveryTime) : OB.I18N.formatHour(currentDate)%></text>
        </line>
      <%}
      }
     }
        promotions = line.get('promotions');
        if (promotions) {
          promotions.forEach(function(p) {
            if (!p.hidden) {
            %>
          <line>
            <text align="left" length="2">--</text>
            <text align="left" length="32"><%= OB.UTIL.encodeXMLComponent(p.name) %></text>
            <text align="right" length="8"><%= OB.I18N.formatCurrency(-p.amt) %></text>
          </line>
          <%
            }
          });
        }
      }
    %>
    <%if(!order.get('priceIncludesTax')){%>
      <line>
        <text align ="left" length="21"><%= OB.I18N.getLabel('OBPOS_LblTotalTax') %></text>
        <text align ="right" length="5"></text>
        <text align ="right" length="8"></text>
        <text align ="right" length="8"><%= OB.I18N.formatCurrency(OB.DEC.sub(order.getGross() , order.getNet())) %></text>  
      </line>
    <%}%>
    <line></line>
    <line size="1">
      <text align ="left" length="25"><%=OB.I18N.getLabel('OBPOS_ReceiptTotal') + ' ' + order.get('currency' + OB.Constants.FIELDSEPARATOR + OB.Constants.IDENTIFIER) %></text>
      <text align ="right" length="14"><%= order.printGross() %></text>
    </line>
      <%
        var payments = order.get('payments');
        var isCancelled = order.get('iscancelled');
        for (var i = 0; i < payments.length; i++) {
          var paymentName = payments.at(i).get('name'), isCancelledPayment;
          if (payments && payments.at(i) && payments.at(i).get('paymentData') && payments.at(i).get('paymentData').name && payments.at(i).get('paymentData').name.length > 0) {
            paymentName = paymentName + ' (' + payments.at(i).get('paymentData').name + ')';
          }
          if(isCancelled && payments.at(i).get('paymentAmount') === 0){
            isCancelledPayment = true;
          }
      if(payments.at(i).get('rate') && payments.at(i).get('rate')!=='1'){
      %>
        <line>
          <text align="left" length="15"><%= paymentName %></text>
          <text align="right" length="12"><%= '('+OB.I18N.formatCurrency(OB.DEC.abs(payments.at(i).get('amount')))+' '+payments.at(i).get('isocode')+')' %></text>
          <text align="right" length="13"><%= OB.I18N.formatCurrency(payments.at(i).get('origAmount')) %></text>
        </line>
     <%
         }else {
     %>
        <line>
          <%
            if(isCancelledPayment){
          %>
            <text align="left" length="20"><%= OB.I18N.getLabel('OBPOS_Cancelled') %></text>
          <%
           } else {
          %>
            <text align="left" length="20"><%= paymentName %></text>
          <% } %>
          <text align="right" length="20"><%= OB.I18N.formatCurrency(payments.at(i).get('amount')) %></text>
        </line>
      <%
        }
          if (payments.at(i).get('gatewayData')) {
          var pinfo = payments.at(i).get('gatewayData');
      %>
        <line>
          <text align="left" length="2"></text>
          <text align="left" length="20"><%= OB.I18N.getLabel('OBPOS_PaymentTran') %></text>
          <text align="left" length="20"><%= pinfo.transaction %></text>
        </line>      
        <line>
          <text align="left" length="2"></text>
          <text align="left" length="20"><%= OB.I18N.getLabel('OBPOS_PaymentApproval') %></text>
          <text align="left" length="20"><%= pinfo.authorization %></text>
        </line>      
        <% if (pinfo.cardmasked) { %>
        <line>
          <text align="left" length="2"></text>
          <text align="left" length="20"><%= OB.I18N.getLabel('OBPOS_PaymentAct') %></text>
          <text align="left" length="20"><%= pinfo.cardmasked %></text>
        </line>  
        <% } %>
        <% if (pinfo.cardlogo) { %>    
        <line>
          <text align="left" length="2"></text>
          <text align="left" length="20"><%= OB.I18N.getLabel('OBPOS_PaymentLogo') %></text>
          <text align="left" length="20"><%= pinfo.cardlogo %></text>
        </line>
        <% } %>
      <%
          }
        }
      %>   
    <% if (order.get('hasbeenpaid') === 'Y' && order.get('paidOnCredit')) { %>
    <line>
      <text align="left" length="20"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_paidOnCredit')) %></text>
      <text align="right" length="20"><%= OB.I18N.formatCurrency(OB.DEC.abs(order.getGross() + order.get('payment'))) %></text>
    </line>
    <% } %>

    <%
      var changelabel = OB.UTIL.getChangeLabelFromReceipt(order);
      if (changelabel) {
        if (changelabel.length > 34) {
          var changesplit = changelabel.split(' + ');
    %>
          <line>
              <text align ="left" length="7"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_ticketChange')) %></text>
              <text align ="right" length="35"><%= changesplit[0] %> </text>
          </line>      
    <%     
          var changeindex;
          for (changeindex = 1; changeindex < changesplit.length; changeindex++) {
    %>
          <line>
              <text align ="right" length="42">+ <%= changesplit[changeindex] %> </text>
          </line> 
    <%      
          }
        } else {
    %>
          <line>
              <text align ="left" length="7"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_ticketChange')) %></text>
              <text align ="right" length="35"><%= changelabel %> </text>
          </line>
    <% 
        }
      } 
    %>
    
    <line></line>
    <line size="1">
      <% if (order.get('hasbeenpaid') === 'N' && !order.get('isPaid')) { %>
        <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckfooter_draft')) %></text>
      <% } else { %>
        <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckfooter_returned')) %></text>
      <% } %>
    </line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckfooter_line2'))%></text>
    </line>
    <line></line>
    <line>
      <text align ="left" length="12"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tck_breakdown'))%></text>
      <text align ="left" length="12"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tck_base'))%></text>
      <text align ="left" length="12"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tck_TAX'))%></text>
    </line>
    <line>
      <text>------------------------------------------</text>
    </line>
    <%
      var totAmount = 0;
      var taxes = order.get('taxes');
      for (var t in taxes) {
        totAmount += taxes[t].amount;
    %>
      <line>
        <text align ="left" length="12"><%= OB.I18N.formatRate(taxes[t].rate) %></text>
        <text align ="left" length="12"><%= OB.I18N.formatCurrency(taxes[t].net) %></text>
        <text align ="left" length="12"><%= OB.I18N.formatCurrency(taxes[t].amount) %></text>
      </line>
    <%
      }
    %>
    <line>
      <text>------------------------------------------</text>
    </line>
    <line>
      <text align ="left" length="24"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_display_total'))%></text>
      <text align ="left" length="12"><%= OB.I18N.formatCurrency(totAmount) %></text>
    </line>

    <line>
      <% if(order.getScannableDocumentNo() !== ''){ %>
        <barcode type="CODE128" position="left"><%= OB.UTIL.encodeXMLComponent(order.getScannableDocumentNo()) %></barcode>
      <% } %>
    </line>

  </ticket>

</output>